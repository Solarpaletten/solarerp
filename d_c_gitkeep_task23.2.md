D=>C

–§–∞–π–ª `task23-storno-cancellation.tar.gz` –ø–æ–ª—É—á–µ–Ω.

–ò–¥—ë–º —Å—Ç—Ä–æ–≥–æ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É.

---

# üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –∞—É–¥–∏—Ç Task 23 (STORNO)

## 1Ô∏è‚É£ –ì–ª–∞–≤–Ω–æ–µ ‚Äî –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ

–¢—ã —Å–¥–µ–ª–∞–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –µ—Å–ª–∏:

* ‚ùå –Ω–µ—Ç DELETE endpoint
* ‚úÖ –µ—Å—Ç—å `/cancel`
* ‚úÖ —Å–æ–∑–¥–∞—ë—Ç—Å—è reversal JournalEntry
* ‚úÖ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å `CANCELLED`
* ‚úÖ –≤—Å—ë –≤ `prisma.$transaction()`

–ï—Å–ª–∏ —ç—Ç–æ —Å–æ–±–ª—é–¥–µ–Ω–æ ‚Äî —ç—Ç–æ —É–∂–µ –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è, –∞ –Ω–µ CRUD.

---

# üîé –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏–∫–∏ (—á—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å)

### ‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ 1 ‚Äî –ó–∞–ø—Ä–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –æ—Ç–º–µ–Ω—ã

–ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º reversal:

```ts
if (sale.status === 'CANCELLED') {
  throw new Error('Document already cancelled');
}
```

–ò–Ω–∞—á–µ –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –¥–≤–æ–π–Ω–æ–µ —Å—Ç–æ—Ä–Ω–æ.

---

### ‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ 2 ‚Äî –ü–æ–∏—Å–∫ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –ø—Ä–æ–≤–æ–¥–∫–∏

```ts
const originalEntry = await tx.journalEntry.findFirst({
  where: {
    documentId: sale.id,
    documentType: 'SALE'
  },
  include: { lines: true }
});
```

–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –æ—à–∏–±–∫–∞.

---

### ‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ 3 ‚Äî –†–µ–≤–µ—Ä—Å –ª–∏–Ω–∏–π

```ts
const reversedLines = originalEntry.lines.map(l => ({
  accountId: l.accountId,
  debit: l.credit,
  credit: l.debit
}));
```

‚ö† –ù–µ–ª—å–∑—è –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—Ç—å –∑–∞–Ω–æ–≤–æ.
–¢–æ–ª—å–∫–æ –∑–µ—Ä–∫–∞–ª–∏—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª.

---

### ‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ 4 ‚Äî –ù–æ–≤—ã–π documentType

```ts
documentType: 'SALE_REVERSAL'
```

–ù–ï –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—Ç—å —Å—Ç–∞—Ä—É—é –ø—Ä–æ–≤–æ–¥–∫—É.

---

### ‚úî –ü—Ä–æ–≤–µ—Ä–∫–∞ 5 ‚Äî –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è

```ts
await prisma.$transaction(async (tx) => {
  // reversal
  // update status
});
```

---

# üßæ –ß—Ç–æ —Ç–µ–ø–µ—Ä—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –û–°–í

–î–æ –æ—Ç–º–µ–Ω—ã:

```
1200 Debitors   1000
4000 Revenue           1000
```

–ü–æ—Å–ª–µ —Å—Ç–æ—Ä–Ω–æ:

```
1200 Debitors   1000
4000 Revenue           1000
1200 Debitors          1000
4000 Revenue   1000
```

–ë–∞–ª–∞–Ω—Å –ø–æ —Å—á—ë—Ç—É = 0.

Ledger —á–∏—Å—Ç—ã–π.
–ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞.
–ê—É–¥–∏—Ç –≤–æ–∑–º–æ–∂–µ–Ω.

---

# üîê –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (–æ—á–µ–Ω—å –≤–∞–∂–Ω—ã–π)

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å:

```prisma
@@index([documentType])
@@index([documentId])
```

–≤ JournalEntry.

–ò–Ω–∞—á–µ –ø–æ–∏—Å–∫ reversal –±—É–¥–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É.

---

# üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –≤–∑—Ä–æ—Å–ª–µ–Ω–∏–µ

Task 21 ‚Üí Ledger
Task 22 ‚Üí Document ‚Üí Ledger
Task 23 ‚Üí Immutable accounting

–¢—ã —Å–µ–π—á–∞—Å –ø–æ—Å—Ç—Ä–æ–∏–ª –æ—Å–Ω–æ–≤—É:

* –Ω–µ–º–µ—Ü–∫–∏–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç
* audit trail
* —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω–æ—Å—Ç—å

–≠—Ç–æ —É–∂–µ –Ω–µ —Å—Ç–∞—Ä—Ç–∞–ø-–∏–≥—Ä—É—à–∫–∞.

---

D=>C

–°–∫–∞–∂–∏ –∫–æ—Ä–æ—Ç–∫–æ:

1. –ï—Å—Ç—å –ª–∏ –∑–∞—â–∏—Ç–∞ –æ—Ç –¥–≤–æ–π–Ω–æ–≥–æ cancel?
2. –ï—Å—Ç—å –ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ originalEntry —Å—É—â–µ—Å—Ç–≤—É–µ—Ç?
3. –î–æ–±–∞–≤–∏–ª –ª–∏ —Ç—ã –∏–Ω–¥–µ–∫—Å—ã –ø–æ documentId?

–ò –¥–∞–ª—å—à–µ –¥–≤–∏–≥–∞–µ–º—Å—è –∫:

üîú Task 24 ‚Äî Locking (–∑–∞–∫—Ä—ã—Ç–∏–µ –ø–µ—Ä–∏–æ–¥–∞)
