D=>C

–ü—Ä–∏–Ω—è—Ç–æ. –ê—É–¥–∏—Ç –ø—Ä–æ—á–∏—Ç–∞–ª –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ. –†–∞–±–æ—Ç–∞ –≤–∑—Ä–æ—Å–ª–∞—è.

---

# –†–µ—à–µ–Ω–∏–µ –ø–æ P0

–ú—ã –ù–ï –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å hard delete –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

–ú—ã –≤—ã–±–∏—Ä–∞–µ–º —Å—Ç—Ä–∞—Ç–µ–≥–∏—é:

# ‚úÖ C) STORNO (reversal pattern)

–ü—Ä–∏—á–∏–Ω—ã:

1. Ledger ‚Äî —ç—Ç–æ immutable —Å–ª–æ–π.
2. –ì–µ—Ä–º–∞–Ω–∏—è = Nachvollziehbarkeit.
3. ERP ‚â† CRUD-–±–∞–∑–∞, —ç—Ç–æ —É—á—ë—Ç–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞.
4. –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ = —Ä–∞–∑—Ä—É—à–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä—Å–∫–æ–≥–æ —Å–ª–µ–¥–∞.

---

# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ —Å —ç—Ç–æ–≥–æ –º–æ–º–µ–Ω—Ç–∞

## üîí 1. SaleDocument / PurchaseDocument –Ω–µ–ª—å–∑—è —É–¥–∞–ª—è—Ç—å

–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ:

```prisma
status String? // OPEN | CANCELLED | LOCKED
```

(–ø–æ–∑–∂–µ –ø–µ—Ä–µ–≤–µ–¥—ë–º –≤ enum)

---

## üîÅ 2. –û—Ç–º–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ =

–í –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:

1. —Å–æ–∑–¥–∞—Ç—å reversal JournalEntry
   (swap debit/credit)
2. –ø–æ–º–µ—Ç–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç status = "CANCELLED"

–ù–∏–∫–∞–∫–∏—Ö delete.

---

# –ü–æ—á–µ–º—É –ù–ï –≤–∞—Ä–∏–∞–Ω—Ç A

–£–¥–∞–ª–µ–Ω–∏–µ journalEntry –≤–º–µ—Å—Ç–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º:

* —É–±–∏–≤–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é
* –ª–æ–º–∞–µ—Ç audit trail
* –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Ä–µ–∞–ª—å–Ω–æ–π –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏–∏

–≠—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ –≤ MVP-sandbox,
–Ω–æ –Ω–µ –≤ Solar ERP 2.0.

---

# –ü–æ –¥—Ä—É–≥–∏–º –ø—É–Ω–∫—Ç–∞–º

## Decimal –≤–∞–ª–∏–¥–∞—Ü–∏—è ‚Äî P1

–î–∞, —Å–æ–≥–ª–∞—Å–µ–Ω.
–°–¥–µ–ª–∞–µ–º –ø–æ—Å–ª–µ stabilization.

–≠—Ç–æ –Ω–µ P0.

---

## 1 document = 1 journalEntry

–î–æ–±–∞–≤–∏–º –ø—Ä–æ–≤–µ—Ä–∫—É –≤ journalService.

P1.

---

# –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥ (Task 23)

C=>D

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å:

1. POST /sales/:id/cancel
2. POST /purchases/:id/cancel

Flow:

```ts
prisma.$transaction(async (tx) => {

  const originalEntry = await tx.journalEntry.findFirst(...)

  const reversedLines = originalEntry.lines.map(l => ({
      accountId: l.accountId,
      debit: l.credit,
      credit: l.debit
  }))

  await createJournalEntry(tx, {
      documentType: 'SALE_REVERSAL',
      documentId: sale.id,
      lines: reversedLines
  })

  await tx.saleDocument.update({
      where: { id },
      data: { status: 'CANCELLED' }
  })
})
```

---

# –í–∞–∂–Ω–æ

Reversal –¥–æ–ª–∂–µ–Ω –∏–º–µ—Ç—å:

```
documentType: 'SALE_REVERSAL'
documentType: 'PURCHASE_REVERSAL'
```

–ß—Ç–æ–±—ã –û–°–í –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ —á–∏—Å—Ç—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç.

---

# –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–∞—è –æ—Ü–µ–Ω–∫–∞

Leanid.

–°–µ–π—á–∞—Å —Ç—ã:

* –Ω–µ —Å—Ç—Ä–æ–∏—à—å CRUD
* —Å—Ç—Ä–æ–∏—à—å –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫—É—é —Å–∏—Å—Ç–µ–º—É
* —É–∂–µ –¥—É–º–∞–µ—à—å –∫–∞–∫ –Ω–µ–º–µ—Ü–∫–∏–π Pr√ºfer

–≠—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å.

---

C=>D

–ü–æ–¥—Ç–≤–µ—Ä–¥–∏, —á—Ç–æ –∏–¥—ë–º —á–µ—Ä–µ–∑ STORNO,
–∏ –ø—Ä–∏—Å—Ç—É–ø–∞–π –∫ Task 23.
