D=>L (Dashka=>Leanid) Принято. Да, это **правильный день** и правильный переход: **Task 25 = P&L Aggregator (backend-only)**. Формирую точное ТЗ Claude прямо сейчас.

---

## D=>C (Dashka=>Claude) — ТЗ Task 25: P&L Aggregator (чистый backend, без UI)

**Цель:** добавить отчёт P&L (Profit & Loss) как чистую агрегацию по журналу.

### 0) Endpoint

`GET /api/company/[companyId]/reports/pnl?from=YYYY-MM-DD&to=YYYY-MM-DD`

### 1) Валидация входа

* `from` и `to` обязательны
* ISO date `YYYY-MM-DD`
* `from <= to`
* company scope / auth как в остальных company endpoints

### 2) Источник данных

Только **posted** проводки:

* берём `JournalLine`
* JOIN `Account`
* фильтр:

  * `JournalLine.companyId = companyId`
  * `JournalLine.date BETWEEN from AND to`
  * `JournalEntry.status = POSTED` (или эквивалент: postedAt != null / state=POSTED — как в модели)
  * `Account.type IN (INCOME, EXPENSE)`

> Важно: **никаких draft**, никаких rebuild.

### 3) Группировка

Group by:

* `accountId`
  Агрегаты:
* `SUM(debit)` как `sumDebit`
* `SUM(credit)` как `sumCredit`

### 4) Расчёт amount

Для каждой группы:

* если `Account.type == INCOME` → `amount = sumCredit - sumDebit`
* если `Account.type == EXPENSE` → `amount = sumDebit - sumCredit`
* вернуть **только строки с amount != 0** (если не сложно; иначе можно оставить)

### 5) Response (MVP)

```json
{
  "period": { "from": "2026-01-01", "to": "2026-01-31" },
  "income": [
    { "accountCode": "90", "accountName": "Revenue", "amount": 10000 }
  ],
  "expenses": [
    { "accountCode": "60", "accountName": "COGS", "amount": 4000 }
  ],
  "result": 6000
}
```

* `result = sum(income.amount) - sum(expenses.amount)`
* Сортировка списков: по `accountCode` ASC (если строковый — лексикографически; ок)

### 6) Файлы / расположение

Создать:
`app/api/company/[companyId]/reports/pnl/route.ts`

Использовать тот же стиль:

* `requireCompanyAccess(...)`
* `prisma` из общего модуля
* единый формат ошибок проекта

### 7) Тестирование (минимум)

* 1–2 smoke-теста через seed (или руками):

  * период, где точно есть INCOME/EXPENSE
  * проверить, что draft не попадают
* В отчёте C=>D приложить:

  * пример curl
  * пример JSON ответа

### 8) Optional (если остаётся время)

`?breakdown=month` или `?monthly=1`:

* вернуть массив месяцев с таким же форматом (period per month)
* но только если MVP уже готов и проверен.

### Definition of Done

* Endpoint работает и отдаёт корректный P&L по posted entries
* Draft entries не учитываются
* Код в согласованном стиле Solar ERP
* Пример запроса/ответа приложен

**Формат ответа:** C=>D (что сделано, файлы, как тестировать).

---

D=>L: ТЗ сформировано. Если хочешь — следующим сообщением дам **точный curl** под ваш локальный dev (с предполагаемым base URL) и чек-лист проверок результата на одном периоде.
