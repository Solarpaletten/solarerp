–û—Ç–ª–∏—á–Ω–æ.
–§–æ—Ä–º–∏—Ä—É—é **D=>C (Dashka ‚Üí Claude)** –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ.
–°—Ç–∏–ª—å ‚Äî –∏–Ω–∂–µ–Ω–µ—Ä–Ω—ã–π, —á—ë—Ç–∫–∏–π, –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.
Claude –¥–æ–ª–∂–µ–Ω –ø–æ–Ω–∏–º–∞—Ç—å, —á—Ç–æ —ç—Ç–æ **–æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π Task 38B**.

---

# üîµ D=>C

# TASK 38B ‚Äî Editable Draft Purchase Document

Claude, —ç—Ç–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ –Ω–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è DRAFT-–¥–æ–∫—É–º–µ–Ω—Ç–∞ –∑–∞–∫—É–ø–∫–∏.

---

# üéØ –¶–µ–ª—å –∑–∞–¥–∞—á–∏

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å **Editable Draft Mode** –¥–ª—è Purchase Document.

–ï—Å–ª–∏:

```ts
purchase.status === 'DRAFT'
```

–¥–æ–∫—É–º–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å:

* –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º
* —Å–æ—Ö—Ä–∞–Ω—è–µ–º—ã–º
* –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º –∫ –ø–æ—Å–ª–µ–¥—É—é—â–µ–º—É posting (Task 39)

–ï—Å–ª–∏:

```ts
purchase.status !== 'DRAFT'
```

–¥–æ–∫—É–º–µ–Ω—Ç –æ—Å—Ç–∞—ë—Ç—Å—è —Å—Ç—Ä–æ–≥–æ read-only.

---

# üìÅ –ó–∞—Ç—Ä–∞–≥–∏–≤–∞–µ–º—ã–µ —Ñ–∞–π–ª—ã

### 1Ô∏è‚É£ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

```
app/(dashboard)/company/[companyId]/purchases/[purchaseId]/page.tsx
```

### 2Ô∏è‚É£ –ù–æ–≤—ã–π API endpoint

```
app/api/company/[companyId]/purchases/[purchaseId]/route.ts
```

–ú–µ—Ç–æ–¥: PUT

---

# üß† –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø

–û–¥–∏–Ω —ç–∫—Ä–∞–Ω ‚Üí –¥–≤–∞ —Ä–µ–∂–∏–º–∞:

```ts
const isEditable = purchase.status === 'DRAFT';
```

–ù–∏–∫–∞–∫–æ–π –æ—Ç–¥–µ–ª—å–Ω–æ–π edit-—Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–µ —Å–æ–∑–¥–∞—ë–º.

---

# üîπ –ß–ê–°–¢–¨ 1 ‚Äî Editable Header

–ï—Å–ª–∏ `isEditable === true`, —Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ª—è —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º—ã–º–∏:

| –ü–æ–ª–µ          | –¢–∏–ø               |
| ------------- | ----------------- |
| purchaseDate  | input type="date" |
| supplierName  | input             |
| supplierCode  | input             |
| warehouseName | select            |
| currencyCode  | select            |
| operationType | select            |
| comments      | textarea          |

–ï—Å–ª–∏ `isEditable === false` ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π PurchaseHeader (read-only).

---

# üîπ –ß–ê–°–¢–¨ 2 ‚Äî Editable Items Grid

–ï—Å–ª–∏ DRAFT:

* –¢–∞–±–ª–∏—Ü–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å inline editing.

* –ü–æ–ª—è:

  * itemName (text)
  * quantity (number)
  * priceWithoutVat (number)
  * vatRate (number)

* –î–æ–ª–∂–Ω—ã –±—ã—Ç—å:

  * –∫–Ω–æ–ø–∫–∞ Add Item
  * –∫–Ω–æ–ø–∫–∞ Delete row

–ï—Å–ª–∏ POSTED ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—É—â–∏–π PurchaseItemsTable (read-only).

---

# üîπ –ß–ê–°–¢–¨ 3 ‚Äî Totals

Totals –¥–æ–ª–∂–Ω—ã:

* —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –∏–∑ `form.items`
* –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –ø—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç `<PurchaseTotals />`

---

# üîπ –ß–ê–°–¢–¨ 4 ‚Äî Save Button

–ï—Å–ª–∏ DRAFT:

–ü–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É:

```
Save
```

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:

* –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PUT –∑–∞–ø—Ä–æ—Å
* –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
* –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:

  * –æ–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π state
  * –ù–ï –¥–µ–ª–∞–µ—Ç reload —Å—Ç—Ä–∞–Ω–∏—Ü—ã

---

# üèõ PUT Endpoint

## –§–∞–π–ª:

```
app/api/company/[companyId]/purchases/[purchaseId]/route.ts
```

## –ú–µ—Ç–æ–¥:

```ts
export async function PUT(...)
```

---

## –õ–æ–≥–∏–∫–∞ PUT

1. requireTenant
2. –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é
3. –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç
4. –µ—Å–ª–∏ status !== 'DRAFT' ‚Üí –≤–µ—Ä–Ω—É—Ç—å 400
5. prisma.$transaction:

   * update purchase fields
   * deleteMany old items
   * createMany new items

---

## PUT Payload

```ts
{
  purchaseDate,
  supplierName,
  supplierCode,
  warehouseName,
  currencyCode,
  operationType,
  comments,
  items: [
    { itemName, quantity, priceWithoutVat, vatRate }
  ]
}
```

---

# ‚ùó –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ

PUT:

* –ù–ï —Å–æ–∑–¥–∞—ë—Ç journal entry
* –ù–ï —Å–æ–∑–¥–∞—ë—Ç stock movement
* –ù–ï —Å–æ–∑–¥–∞—ë—Ç FIFO
* –ù–ï –º–µ–Ω—è–µ—Ç status

Posting –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –æ—Ç–¥–µ–ª—å–Ω–æ (Task 39).

---

# üîí –ë—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∞—è –ª–æ–≥–∏–∫–∞

Draft:

* –¥–æ–∫—É–º–µ–Ω—Ç –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±–µ–∑ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
* –Ω–µ –æ—Ç—Ä–∞–∂—ë–Ω –≤ —É—á—ë—Ç–µ

Posted:

* –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
* —Ç–æ–ª—å–∫–æ —Å—Ç–æ—Ä–Ω–æ (–±—É–¥–µ—Ç –ø–æ–∑–∂–µ)

---

# üé® UI –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

–í Header, –µ—Å–ª–∏ DRAFT:

```
[DRAFT badge]   Save   Post (disabled –ø–æ–∫–∞)
```

–ï—Å–ª–∏ POSTED:

```
[POSTED badge]
```

---

# üìå –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

* –ù–µ –ª–æ–º–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π read-only —Ä–µ–∂–∏–º.
* –ù–µ –∏–∑–º–µ–Ω—è—Ç—å –ª–æ–≥–∏–∫—É draft endpoint.
* –ù–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å heavy POST (—ç—Ç–æ Task 39).

---

# üì¶ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:

1. –°–æ–∑–¥–∞—ë–º draft.
2. –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç.
3. –î–æ–∫—É–º–µ–Ω—Ç editable.
4. –î–æ–±–∞–≤–ª—è–µ–º items.
5. –ù–∞–∂–∏–º–∞–µ–º Save.
6. –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
7. –°—Ç–∞—Ç—É—Å –æ—Å—Ç–∞—ë—Ç—Å—è DRAFT.

---

# üß≠ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏—ë–º–∫–∏

‚úî Editable header —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úî Editable items grid —Ä–∞–±–æ—Ç–∞–µ—Ç
‚úî Totals –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è
‚úî PUT –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç
‚úî –ù–µ–ª—å–∑—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å POSTED –¥–æ–∫—É–º–µ–Ω—Ç
‚úî –ù–µ—Ç journal / stock / FIFO –ø—Ä–∏ Save

---

Claude, —Ä–µ–∞–ª–∏–∑—É–π –∞–∫–∫—É—Ä–∞—Ç–Ω–æ, –±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –ª–æ–≥–∏–∫–∏, –±–µ–∑ –Ω–∞—Ä—É—à–µ–Ω–∏—è tenant isolation.

–ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ ‚Äî –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å diff-–æ–±–∑–æ—Ä –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ ‚Äî –º–æ–≥—É –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π D=>C –Ω–∞ Task 39 (Posting Engine Separation).
