// ============================================
// Task 35: FIFO ENGINE — StockLot + StockAllocation
// ============================================
// ADD to prisma/schema.prisma
// ADD stockLots/stockAllocations relations to Company model

// ─── Add to Company model relations: ─────────────
//   stockLots         StockLot[]
//   stockAllocations  StockAllocation[]

model StockLot {
  id                 String   @id @default(cuid())
  companyId          String
  warehouseName      String
  itemCode           String
  itemName           String
  sourceDocumentType String   @default("PURCHASE")
  sourceDocumentId   String
  purchaseDate       DateTime
  unitCost           Decimal  @db.Decimal(18, 2)
  qtyInitial         Decimal  @db.Decimal(18, 4)
  qtyRemaining       Decimal  @db.Decimal(18, 4)
  currencyCode       String   @default("EUR")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  company     Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  allocations StockAllocation[]

  // FIFO ordering index — critical for deterministic allocation
  @@index([companyId, warehouseName, itemCode, purchaseDate, id], name: "stock_lots_fifo_idx")
  @@index([companyId, sourceDocumentId], name: "stock_lots_source_idx")
  @@index([companyId])
  @@map("stock_lots")
}

model StockAllocation {
  id           String   @id @default(cuid())
  companyId    String
  documentType String   // SALE | SALE_REVERSAL
  documentId   String
  saleItemId   String?
  lotId        String
  qty          Decimal  @db.Decimal(18, 4)
  unitCost     Decimal  @db.Decimal(18, 2)
  amount       Decimal  @db.Decimal(18, 2)
  createdAt    DateTime @default(now())

  company Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)
  lot     StockLot @relation(fields: [lotId], references: [id], onDelete: Restrict)

  @@index([companyId, documentType, documentId], name: "stock_allocations_doc_idx")
  @@index([companyId, lotId], name: "stock_allocations_lot_idx")
  @@index([companyId])
  @@map("stock_allocations")
}
