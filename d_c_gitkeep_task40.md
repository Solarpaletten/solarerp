D=>C (Dashka‚ÜíClaude) –¢–ó: –∞—É–¥–∏—Ç + —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è Purchases (–ø—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤) ‚Äú–ø–æ–¥ –∫–ª—é—á‚Äù + —Ä–µ–≤–∏–∑–∏—è —Ñ–∞–π–ª–æ–≤
–†–æ–ª—å: –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç-–∞—É–¥–∏—Ç–æ—Ä –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–æ–≥–æ —É—á–µ—Ç–∞ (–Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –≤ –∫–æ–¥–µ/—Ñ–ª–æ—É –ø—Ä–æ–¥—É–∫—Ç–∞).

0) –ö–æ–Ω—Ç–µ–∫—Å—Ç –∏ —Ü–µ–ª—å

–ú—ã —É–∂–µ —Ä–∞–∑–¥–µ–ª–∏–ª–∏ ‚Äú—Å–æ–∑–¥–∞–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞‚Äù –∏ ‚Äú–ø–æ—Å—Ç–∏–Ω–≥‚Äù. –°–µ–π—á–∞—Å –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–µ—Å—å –ø–æ—Ç–æ–∫ ‚Äú–ü—Ä–∏—Ö–æ–¥ —Ç–æ–≤–∞—Ä–æ–≤‚Äù:

–°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞–∫—É–ø–æ–∫ (Purchases list)

–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —á–µ—Ä–µ–∑ Draft endpoint –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç

–°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (DRAFT —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è)

PUT —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–≤–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –º—É—Å–æ—Ä–∞)

POSTING (Task 39): DRAFT ‚Üí POSTED, —Å–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–æ–≤–æ–¥–æ–∫/—Å–∫–ª–∞–¥–∞/FIFO –≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏

–ü–æ—Å–ª–µ POSTED ‚Äî –¥–æ–∫—É–º–µ–Ω—Ç read-only, —Å–ø–∏—Å–æ–∫ –æ—Ç—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ —Å—É–º–º—ã

1) –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∞—É–¥–∏—Ç ‚Äú–∫–∞–∫ –±—É—Ö–≥–∞–ª—Ç–µ—Ä‚Äù)
1.1 –î–æ–∫—É–º–µ–Ω—Ç –ø—Ä–∏—Ö–æ–¥–∞ (PurchaseDocument)

–î–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–æ–ª—è: –¥–∞—Ç–∞, –ø–æ—Å—Ç–∞–≤—â–∏–∫, —Å–∫–ª–∞–¥, –≤–∞–ª—é—Ç–∞, —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏.

–í DRAFT –¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –ø—É—Å—Ç—ã–µ –ø–æ–ª—è/–Ω–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤, –Ω–æ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ post ‚Äî —Å—Ç—Ä–æ–≥–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è.

–°–µ—Ä–∏—è/–Ω–æ–º–µ—Ä –Ω–µ –¥–æ–ª–∂–Ω—ã –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å (—É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å + –∞–≤—Ç–æ–Ω—É–º–µ—Ä–∞—Ü–∏—è –≤ draft).

1.2 –°—Ç—Ä–æ–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤ (items)

–í DRAFT –º–æ–∂–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å.

–ü–µ—Ä–µ–¥ Posting:

min 1 item

itemName –Ω–µ –ø—É—Å—Ç–æ–π

quantity > 0

priceWithoutVat ‚â• 0

vatRate 0..100 (–µ—Å–ª–∏ –µ—Å—Ç—å)

1.3 –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è / –ø—Ä–æ–≤–æ–¥–∫–∏ (–ø–æ—Å–ª–µ Posting)

–ü—Ä–æ–≤–æ–¥–∫–∞ –æ–¥–Ω–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç: DR Inventory (–∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–±–µ—Ç) / CR Payable (–∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∫—Ä–µ–¥–∏—Ç) –Ω–∞ —Å—É–º–º—É net total.

–ó–∞–ø—Ä–µ—Ç–∏—Ç—å Posting –ø—Ä–∏ –ø—É—Å—Ç—ã—Ö accounts (debitAccountId/creditAccountId).

1.4 –°–∫–ª–∞–¥ / FIFO (–ø–æ—Å–ª–µ Posting)

StockMovement IN –ø–æ –∫–∞–∂–¥–æ–º—É item.

FIFO lot –ø–æ –∫–∞–∂–¥–æ–º—É item, quantity –∏ unitCost —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç item.

2) –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ (–∫–∞–∫ –∏–Ω–∂–µ–Ω–µ—Ä)
2.1 –†–æ—É—Ç—ã API (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫)

–ü—Ä–æ–≤–µ—Ä—å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:

GET /api/company/[companyId]/purchases

–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { data: PurchaseDocument[] }

include items (–∏–Ω–∞—á–µ total –Ω–µ –ø–æ—Å—á–∏—Ç–∞—Ç—å –≤ UI)

POST /api/company/[companyId]/purchases/draft (Task 38A)

—Å–æ–∑–¥–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π DRAFT, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç { data: { id } }

–∞–≤—Ç–æ–Ω—É–º–µ—Ä–∞—Ü–∏—è —Å–µ—Ä–∏–∏ P

GET /api/company/[companyId]/purchases/[purchaseId] (Task 37A)

–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç + items

PUT /api/company/[companyId]/purchases/[purchaseId] (Task 38B + 38B.A)

–æ–±–Ω–æ–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ DRAFT

–¥–µ–ª–∞–µ—Ç replace items (deleteMany ‚Üí createMany)

–¥–æ–±–∞–≤—å/–ø—Ä–æ–≤–µ—Ä—å –≤–∞–ª–∏–¥–∞—Ü–∏—é (—á—Ç–æ–±—ã –Ω–µ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —è–≤–Ω—ã–π –º—É—Å–æ—Ä)

POST /api/company/[companyId]/purchases/[purchaseId]/post (Task 39)

DRAFT ‚Üí POSTED

–≤ –æ–¥–Ω–æ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: validate ‚Üí assertPeriodOpen ‚Üí journal ‚Üí stock IN ‚Üí FIFO ‚Üí status POSTED

–æ—à–∏–±–∫–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ status codes

2.2 UI —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫)

/company/[companyId]/purchases ‚Äî —Å–ø–∏—Å–æ–∫

/company/[companyId]/purchases/new ‚Äî —Å–æ–∑–¥–∞–µ—Ç draft –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç

/company/[companyId]/purchases/[purchaseId] ‚Äî dual mode (DRAFT edit / POSTED read-only)

3) –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å (–ø–æ —à–∞–≥–∞–º)
–®–∞–≥ A ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ ‚Äú–≤—ã–ª–µ—á–∏—Ç—å‚Äù —Ç–µ–∫—É—â–∏–µ UI-—Ñ–∞–π–ª—ã Purchases

–°–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã props –º–µ–∂–¥—É PurchasesPage –∏ PurchaseTable.

–†–∞–Ω–µ–µ –±—ã–ª –∫–æ–Ω—Ñ–ª–∏–∫—Ç (PurchaseTable –æ–∂–∏–¥–∞–ª selectedIds/onSelectionChange/isLoading), —Å–µ–π—á–∞—Å —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —É–ø—Ä–æ—â–µ–Ω–∞.

–£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ —Å–±–æ—Ä–∫–∞ –Ω–µ –ø–∞–¥–∞–µ—Ç –∏ TS –Ω–µ —Ä—É–≥–∞–µ—Ç—Å—è.

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞—â–∏—Ç—É –æ—Ç ‚Äúundefined items‚Äù:

–í —Ç–∞–±–ª–∏—Ü–µ: purchase.items?.length ?? 0 –∏ calcTotal(purchase.items || []) ‚úÖ

–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É ‚ÄúNew Purchase‚Äù (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç) ‚Äî —ç—Ç–æ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è UX.

–≠—Ç–æ –Ω–µ –ª–æ–º–∞–µ—Ç –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—é, –Ω–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ç–µ—Å—Ç.

–®–∞–≥ B ‚Äî –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ç–µ—Å—Ç end-to-end –≤—Ä—É—á–Ω—É—é (–º–∏–Ω–∏–º—É–º)

–°–¥–µ–ª–∞—Ç—å –ø—Ä–æ–≥–æ–Ω –≤ –±—Ä–∞—É–∑–µ—Ä–µ:

–û—Ç–∫—Ä—ã—Ç—å —Å–ø–∏—Å–æ–∫ Purchases ‚Üí –¥–æ–ª–∂–Ω–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫.

–ù–∞–∂–∞—Ç—å ‚ÄúNew‚Äù (–∏–ª–∏ –Ω–∞–ø—Ä—è–º—É—é /purchases/new) ‚Üí –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å—Å—è DRAFT ‚Üí —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /purchases/[id].

–ó–∞–ø–æ–ª–Ω–∏—Ç—å header + 2 items ‚Üí Save ‚Üí –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Üí –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.

–ù–∞–∂–∞—Ç—å Post ‚Üí –¥–æ–ª–∂–µ–Ω —Å—Ç–∞—Ç—å POSTED, UI —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è read-only, —Å—Ç–∞—Ç—É—Å –∑–µ–ª—ë–Ω—ã–π –≤ —Å–ø–∏—Å–∫–µ.

–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ë–î (prisma studio/SQL) —á—Ç–æ –ø–æ—è–≤–∏–ª–∏—Å—å:

journalEntry (+ lines)

stockMovements IN

stockLots FIFO

purchase.status = POSTED

–®–∞–≥ C ‚Äî –≤—ã–≤–µ—Å—Ç–∏ ‚Äú—á–∏—Å—Ç—ã–µ –≤–µ—Ä—Å–∏–∏‚Äù –∫–ª—é—á–µ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤

–ù—É–∂–Ω–æ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤ PR/–æ—Ç–≤–µ—Ç–µ –∏—Ç–æ–≥–æ–≤—ã–µ –≤–µ—Ä—Å–∏–∏ (–±–µ–∑ –º—É—Å–æ—Ä–∞/—ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤):

app/(dashboard)/company/[companyId]/purchases/page.tsx

components/purchases/PurchaseTable.tsx

–ø–ª—é—Å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ Purchase* (header/items/totals/edit) –∏ –≤—Å–µ API routes Purchases.

4) –§–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ ‚Äú–ø–æ–¥–Ω—è—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤—Å–µ‚Äù

UI:

app/(dashboard)/company/[companyId]/purchases/page.tsx

app/(dashboard)/company/[companyId]/purchases/new/page.tsx

app/(dashboard)/company/[companyId]/purchases/[purchaseId]/page.tsx

components/purchases/PurchaseTable.tsx

components/purchases/PurchaseHeader.tsx

components/purchases/PurchaseHeaderEdit.tsx

components/purchases/PurchaseItemsTable.tsx

components/purchases/PurchaseItemsEdit.tsx

components/purchases/PurchaseTotals.tsx

API:

app/api/company/[companyId]/purchases/route.ts

app/api/company/[companyId]/purchases/draft/route.ts

app/api/company/[companyId]/purchases/[purchaseId]/route.ts

app/api/company/[companyId]/purchases/[purchaseId]/post/route.ts

5) Acceptance Criteria (—á—Ç–æ —Å—á–∏—Ç–∞–µ–º ‚Äú–≥–æ—Ç–æ–≤–æ‚Äù)

‚úÖ /purchases/new –Ω–µ –ø–∞–¥–∞–µ—Ç, —Å–æ–∑–¥–∞–µ—Ç DRAFT –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç

‚úÖ DRAFT –¥–æ–∫—É–º–µ–Ω—Ç —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ PUT (header + items)

‚úÖ PUT –∏–º–µ–µ—Ç –±–∞–∑–æ–≤—É—é –≤–∞–ª–∏–¥–∞—Ü–∏—é (–Ω–µ –¥–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —è–≤–Ω—ã–π —Ç—Ä—ç—à)

‚úÖ Posting —Ä–∞–±–æ—Ç–∞–µ—Ç –∞—Ç–æ–º–∞—Ä–Ω–æ: –ª–∏–±–æ –≤—Å—ë —Å–æ–∑–¥–∞–ª–æ—Å—å, –ª–∏–±–æ –Ω–∏—á–µ–≥–æ

‚úÖ POSTED –¥–æ–∫—É–º–µ–Ω—Ç read-only

‚úÖ –¢–∞–±–ª–∏—Ü–∞ Purchases –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—á–∏—Ç–∞–µ—Ç totals

‚úÖ –ù–µ—Ç 500 ‚ÄúUnexpected end of JSON input‚Äù –Ω–∞ draft-—Å—Ü–µ–Ω–∞—Ä–∏–∏

‚úÖ –ù–∏–∫–∞–∫–∏—Ö TS –æ—à–∏–±–æ–∫ –ø–æ props/—Ç–∏–ø–∞–º

6) ‚Äú–í–µ—Å—å —Ñ–∞–π–ª‚Äù ‚Äî –∞–∫—Ç—É–∞–ª—å–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ (—Ñ–∏–∫—Å–∏—Ä—É–µ–º)

–ù–∏–∂–µ –¥–∞—é –ø–æ–ª–Ω—ã–µ –≤–µ—Ä—Å–∏–∏ –¥–≤—É—Ö —Ñ–∞–π–ª–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø—Ä–æ—Å–∏–ª –≤—ã–≤–µ—Å—Ç–∏ –∏ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å.

app/(dashboard)/company/[companyId]/purchases/page.tsx
// app/(dashboard)/company/[companyId]/purchases/page.tsx
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Task 38 39: Purchases Module Page
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

'use client';

import { useEffect, useState } from 'react';
import { useParams } from 'next/navigation';
import PurchaseTable from '@/components/purchases/PurchaseTable';
import { Loader2 } from 'lucide-react';

interface Purchase {
  id: string;
  series: string;
  number: string;
  purchaseDate: string;
  supplierName: string;
  currencyCode: string;
  status: string | null;
  totalAmount?: number;
}

export default function PurchasesPage() {
  const params = useParams();
  const companyId = params.companyId as string;

  const [purchases, setPurchases] = useState<Purchase[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    async function loadPurchases() {
      try {
        setIsLoading(true);
        setError(null);

        const res = await fetch(`/api/company/${companyId}/purchases`);

        if (!res.ok) {
          throw new Error('Failed to load purchases');
        }

        const json = await res.json();

        // üîê SAFETY: always extract array from json.data
        const safeArray = Array.isArray(json.data) ? json.data : [];

        setPurchases(safeArray);
      } catch (err) {
        setError(err instanceof Error ? err.message : 'Unknown error');
      } finally {
        setIsLoading(false);
      }
    }

    if (companyId) {
      loadPurchases();
    }
  }, [companyId]);

  if (isLoading) {
    return (
      <div className="p-6 flex items-center justify-center py-20">
        <Loader2 className="animate-spin text-gray-300" size={24} />
        <span className="ml-2 text-sm text-gray-400">Loading purchases...</span>
      </div>
    );
  }

  if (error) {
    return (
      <div className="p-6">
        <div className="bg-white border border-gray-200 rounded-lg p-12 text-center">
          <p className="text-red-500 text-sm">{error}</p>
        </div>
      </div>
    );
  }

  return (
    <div className="p-6">
      <PurchaseTable purchases={purchases} companyId={companyId} />
    </div>
  );
}
components/purchases/PurchaseTable.tsx
'use client';

import { useRouter } from 'next/navigation';
import { Package } from 'lucide-react';

interface PurchaseItem {
  id: string;
  itemName: string;
  quantity: string | number;
  priceWithoutVat: string | number;
}

interface PurchaseDocument {
  id: string;
  series: string;
  number: string;
  purchaseDate: string;
  supplierName: string;
  warehouseName: string;
  operationType: string;
  currencyCode: string;
  status: string | null;
  items: PurchaseItem[];
}

interface PurchaseTableProps {
  purchases: PurchaseDocument[];
  companyId: string;
}

function formatDate(dateStr: string): string {
  return new Date(dateStr).toLocaleDateString('de-DE', {
    day: '2-digit',
    month: '2-digit',
    year: 'numeric',
  });
}

function calcTotal(items: PurchaseItem[]): string {
  const total = items.reduce(
    (sum, item) => sum + Number(item.quantity) * Number(item.priceWithoutVat),
    0
  );

  return total.toLocaleString('de-DE', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
}

const STATUS_STYLES: Record<string, string> = {
  DRAFT: 'bg-gray-50 text-gray-600 border-gray-200',
  POSTED: 'bg-green-50 text-green-600 border-green-200',
  CANCELLED: 'bg-red-50 text-red-600 border-red-200',
  LOCKED: 'bg-blue-50 text-blue-600 border-blue-200',
};

export default function PurchaseTable({ purchases, companyId }: PurchaseTableProps) {
  const router = useRouter();
  const safePurchases = Array.isArray(purchases) ? purchases : [];

  if (safePurchases.length === 0) {
    return (
      <div className="bg-white rounded-lg border border-gray-200 p-12 text-center">
        <Package className="mx-auto mb-3 text-gray-300" size={40} />
        <p className="text-gray-500 text-sm mb-1">No purchase documents yet</p>
        <p className="text-gray-400 text-xs">Create your first purchase to get started</p>
      </div>
    );
  }

  return (
    <div className="bg-white rounded-lg border border-gray-200 overflow-hidden">
      <div className="overflow-x-auto">
        <table className="w-full text-sm">
          <thead>
            <tr className="bg-gray-50 border-b border-gray-200">
              <th className="px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                Doc #
              </th>
              <th className="px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                Date
              </th>
              <th className="px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                Supplier
              </th>
              <th className="px-3 py-2.5 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                Warehouse
              </th>
              <th className="px-3 py-2.5 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">
                Total (net)
              </th>
              <th className="px-3 py-2.5 text-center text-xs font-semibold text-gray-500 uppercase tracking-wider">
                Status
              </th>
            </tr>
          </thead>

          <tbody className="divide-y divide-gray-100">
            {safePurchases.map((purchase) => {
              const status = purchase.status || 'DRAFT';
              const statusStyle =
                STATUS_STYLES[status] || 'bg-gray-50 text-gray-500 border-gray-200';

              return (
                <tr
                  key={purchase.id}
                  onClick={() => router.push(`/company/${companyId}/purchases/${purchase.id}`)}
                  className="cursor-pointer hover:bg-gray-50 transition-colors"
                >
                  <td className="px-3 py-2.5 font-mono text-xs font-medium text-gray-900">
                    {purchase.series}-{purchase.number}
                  </td>

                  <td className="px-3 py-2.5 text-gray-600 text-xs">
                    {formatDate(purchase.purchaseDate)}
                  </td>

                  <td className="px-3 py-2.5 text-gray-800 font-medium text-xs">
                    {purchase.supplierName}
                  </td>

                  <td className="px-3 py-2.5 text-gray-500 text-xs">
                    {purchase.warehouseName}
                  </td>

                  <td className="px-3 py-2.5 text-right font-mono text-xs text-gray-900 tabular-nums">
                    ‚Ç¨{calcTotal(purchase.items || [])}
                  </td>

                  <td className="px-3 py-2.5 text-center">
                    <span
                      className={`inline-block px-2 py-0.5 text-[10px] font-semibold uppercase rounded border ${statusStyle}`}
                    >
                      {status}
                    </span>
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>
    </div>
  );
}